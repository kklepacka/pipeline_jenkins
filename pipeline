pipeline {
    agent any
    environment {
        WORKFLOW_ID = ''
        OPENTF_RUN_Navigateur = 'firefox'
    }
    stages {
        stage('Run Workflow') {
            steps {
                script {
                    // Exécuter le workflow et capturer le résultat
                    def workflow_command = 'opentf-ctl run workflow .opentf/suite_connexion.json'
                    def workflow_result = bat(returnStdout: true, script: workflow_command).trim()
                    echo "Résultat du workflow: ${workflow_result}"

                    // Extraire le WORKFLOW_ID du résultat
                    def workflow_id_match = (workflow_result =~ /Workflow ([\w-]+)/)
                    if (workflow_id_match) {
                        WORKFLOW_ID = workflow_id_match[0][1].toString()
                        echo "WORKFLOW_ID extrait: ${WORKFLOW_ID}"
                    } else {
                        error("Échec de l'extraction du WORKFLOW_ID du résultat du workflow: ${workflow_result}")
                    }
                }
            }
        }
        stage('Wait for workflow to finish') {
            steps {
                script {
                    // Define the watch command
                    def watch_command = "opentf-ctl get workflow ${WORKFLOW_ID} --watch"
                    
                    // Set up retry mechanism with timeout
                    timeout(time: 60, unit: 'MINUTES') {  // Adjust timeout as needed
                        retry(3) {  // Will retry up to 3 times
                            try {
                                // Execute with specific encoding to handle Unicode characters
                                withEnv(['PYTHONIOENCODING=utf8']) {
                                    bat script: """
                                        @echo off
                                        chcp 65001 > nul
                                        ${watch_command}
                                    """
                                }
                            } catch (Exception e) {
                                // Check if workflow is actually complete despite the error
                                def status_command = "opentf-ctl get workflow ${WORKFLOW_ID} --output json"
                                def status = bat(script: status_command, returnStdout: true).trim()
                                
                                // If workflow is complete (status is success/failed/terminated), continue
                                if (status.contains('"status": "completed"') || 
                                    status.contains('"status": "failed"') || 
                                    status.contains('"status": "terminated"')) {
                                    echo "Workflow completed with status: ${status}"
                                    return
                                }
                                
                                // If workflow is still running, throw the error to trigger retry
                                throw e
                            }
                        }
                    }
                }
            }
        }
        stage('Prepare Workspace') {
            steps {
                script {
                    // S'assurer que l'espace de travail est propre
                    bat 'if exist executionreport.html del executionreport.html'
                }
            }
        }

        stage('Get Attachments') {
            steps {
                script {
                    sleep(time: 20, unit: 'SECONDS') // Délai pour garantir que les fichiers sont disponibles
                    def attach_html = "opentf-ctl cp ${WORKFLOW_ID}:*.html ."
                    def attach_html_result = bat(returnStdout: true, script: attach_html).trim()
                    echo "Résultat de la copie des pièces jointes: ${attach_html_result}"
                }
            }
        }

        stage('Publish HTML Report') {
            steps {
                publishHTML(target: [
                    allowMissing: false,
                    alwaysLinkToLastBuild: true,
                    keepAll: true,
                    reportDir: '.',
                    reportFiles: 'executionreport.html',
                    reportName: 'Rapport de Test',
                    reportTitles: 'Rapport d\'Exécution'
                ])
            }
        }

        stage('Apply Quality Gate') {
            steps {
                script {
                    def qg_command = "opentf-ctl get qualitygate ${WORKFLOW_ID} --mode strict"
                    def qg_result = bat(returnStdout: true, script: qg_command).trim()
                    echo "Résultat de la Quality Gate: ${qg_result}"
                }
            }
        }
    }
}
